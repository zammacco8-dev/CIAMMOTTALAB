<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Magazzino Usato ‚Äî Scanner + Descrizioni</title>
  <style>
    :root{
      --bg:#0b0d12;
      --card:#121624;
      --muted:#8f9bb7;
      --txt:#eef2ff;
      --accent:#4f7cff;
      --ok:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:#1e263d;
      --btn:#1a223a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 30% -10%, rgba(79,124,255,.25), transparent 55%),
                  radial-gradient(900px 700px at 100% 10%, rgba(45,212,191,.18), transparent 50%),
                  var(--bg);
      color:var(--txt);
    }
    header{
      position:sticky; top:0; z-index:5;
      padding:14px 14px 10px;
      background: rgba(11,13,18,.82);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .tabs{display:flex; gap:8px; margin-top:10px}
    .tab{
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(255,255,255,.04);
      color:var(--txt);
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{background: rgba(79,124,255,.18); border-color: rgba(79,124,255,.5)}
    main{padding:14px; max-width:1100px; margin:0 auto}
    .grid{display:grid; gap:12px}
    @media (min-width:900px){ .grid.cols2{grid-template-columns: 1.1fr .9fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    h1{font-size:18px; margin:0}
    h2{font-size:14px; margin:0 0 10px; color:var(--muted); font-weight:800; letter-spacing:.02em; text-transform:uppercase}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color:var(--txt);
      outline:none;
    }
    textarea{min-height:120px; resize:vertical}
    .btn{
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: var(--btn);
      color:var(--txt);
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{background: rgba(79,124,255,.25); border-color: rgba(79,124,255,.55)}
    .btn.ok{background: rgba(45,212,191,.18); border-color: rgba(45,212,191,.55)}
    .btn.bad{background: rgba(251,113,133,.18); border-color: rgba(251,113,133,.55)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .pill strong{color:var(--txt)}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .divider{height:1px; background: rgba(255,255,255,.08); margin:12px 0}
    .preview{
      display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;
    }
    .imgbox{
      width:140px; height:140px; border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .imgbox img{width:100%; height:100%; object-fit:cover}
    table{width:100%; border-collapse:collapse}
    th, td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 8px;
      text-align:left;
      vertical-align:top;
      font-size:13px;
    }
    th{color:var(--muted); font-weight:900; font-size:12px; text-transform:uppercase; letter-spacing:.02em}
    .right{text-align:right}
    .status{
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      display:inline-block;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:12px;
    }
    .status.in{color:var(--ok); border-color: rgba(45,212,191,.45); background: rgba(45,212,191,.12)}
    .status.out{color:var(--warn); border-color: rgba(251,191,36,.45); background: rgba(251,191,36,.12)}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.12);
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      max-width:92vw;
      opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      backdrop-filter: blur(8px);
      font-weight:800;
      font-size:13px;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}
    video{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:#000;
      max-height:320px;
    }
    .dangerBox{
      border:1px solid rgba(251,113,133,.35);
      background: rgba(251,113,133,.08);
      border-radius:16px;
      padding:12px;
      color:var(--txt);
    }
  </style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <h1>üì¶ Magazzino Usato ‚Äî Scanner + Descrizioni</h1>
    <span class="pill">Salvataggio: <strong>Locale</strong></span>
  </div>
  <div class="tabs">
    <div class="tab active" data-tab="add">‚ûï Nuovo articolo</div>
    <div class="tab" data-tab="stock">üè∑Ô∏è Magazzino</div>
    <div class="tab" data-tab="settings">‚öôÔ∏è Dati & Export</div>
  </div>
</header>

<div id="secureBanner" style="display:none;padding:12px 14px;max-width:1100px;margin:10px auto 0;border-radius:16px;border:1px solid rgba(251,191,36,.45);background:rgba(251,191,36,.12);color:var(--txt);font-weight:800">
  ‚ö†Ô∏è Scanner barcode disattivato: questa pagina non √® in <b>HTTPS</b>. Pubblicala su GitHub Pages (https) oppure aprila da <b>localhost</b> su PC.
</div>

<main>
  <!-- TAB: ADD -->
  <section id="tab-add" class="grid cols2">
    <div class="card">
      <h2>1) Foto + Barcode</h2>

      <div class="grid" style="gap:10px">
        <div class="preview">
          <div class="imgbox" id="imgBox">
            <span class="muted small">Nessuna foto</span>
          </div>
          <div style="flex:1; min-width:220px">
            <label>Foto articolo (camera)</label>
            <input id="photoInput" type="file" accept="image/*" capture="environment" />
            <div class="row" style="margin-top:10px">
              <button class="btn" id="clearPhotoBtn" type="button">Rimuovi foto</button>
              <span class="muted small">La foto viene compressa per non saturare la memoria.</span>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <label>Scanner barcode (camera)</label>
        <video id="video" playsinline></video>
        <div class="row">
          <button class="btn primary" id="startScanBtn" type="button">Avvia scanner</button>
          <button class="btn" id="stopScanBtn" type="button" disabled>Stop</button>
          <span class="pill">Barcode: <strong id="barcodePill">‚Äî</strong></span>
        </div>

        <div class="dangerBox small">
          ‚ö†Ô∏è Se lo scanner non parte: apri questa pagina in <b>Chrome</b> (Android) o <b>Safari</b> (iPhone) e concedi permessi camera.
          Su PC serve <b>https</b> o <b>localhost</b> per usare la camera.
        </div>
      </div>
    </div>

    <div class="card">
      <h2>2) Dati articolo</h2>

      <div class="grid" style="gap:10px">
        <div class="row">
          <div style="flex:1; min-width:180px">
            <label>Categoria</label>
            <select id="category">
              <option value="Smartphone">Smartphone</option>
              <option value="Laptop">Laptop</option>
              <option value="Console">Console</option>
              <option value="Scheda Video">Scheda Video</option>
              <option value="Cuffie">Cuffie</option>
              <option value="Controller">Controller</option>
              <option value="Altro">Altro</option>
            </select>
          </div>
          <div style="flex:1; min-width:180px">
            <label>Condizioni</label>
            <select id="condition">
              <option value="Come nuovo">Come nuovo</option>
              <option value="Ottime">Ottime</option>
              <option value="Buone">Buone</option>
              <option value="Usato (segni evidenti)">Usato (segni evidenti)</option>
              <option value="Da sistemare / Ricambi">Da sistemare / Ricambi</option>
            </select>
          </div>
        </div>

        <label>Titolo / Modello (es. ‚ÄúSamsung Galaxy S23 128GB‚Äù)</label>
        <input id="title" placeholder="Marca + modello + taglio (se serve)" />

        <div class="row">
          <div style="flex:1; min-width:180px">
            <label>Marca</label>
            <input id="brand" placeholder="Samsung / Apple / Sony..." />
          </div>
          <div style="flex:1; min-width:180px">
            <label>Barcode (manuale se serve)</label>
            <input id="barcode" placeholder="EAN/UPC..." />
          </div>
        </div>

        <div class="row">
          <div style="flex:1; min-width:180px">
            <label>Prezzo tuo di acquisto (‚Ç¨)</label>
            <input id="buyPrice" type="number" inputmode="decimal" placeholder="Es. 120" />
          </div>
          <div style="flex:1; min-width:180px">
            <label>Prezzo nuovo (oggi) (‚Ç¨) ‚Äî se lo sai</label>
            <input id="newPrice" type="number" inputmode="decimal" placeholder="Es. 199" />
          </div>
        </div>

        <label>Accessori inclusi (caricatore, scatola, cavi‚Ä¶)</label>
        <input id="accessories" placeholder="Es. scatola + cavo + alimentatore originale" />

        <label>Difetti / Note oneste</label>
        <textarea id="notes" placeholder="Es. batteria ok, un graffio sul retro, tutto funzionante..."></textarea>

        <div class="row">
          <button class="btn primary" id="genBtn" type="button">Genera descrizione</button>
          <button class="btn" id="copyBtn" type="button">Copia descrizione</button>
          <button class="btn ok" id="saveBtn" type="button">Salva in magazzino</button>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between">
          <span class="pill">Rivendita consigliata: <strong id="suggestedPill">‚Äî</strong></span>
          <button class="btn" id="suggestBtn" type="button">Suggerisci rivendita</button>
        </div>

        <label>Descrizione pronta</label>
        <textarea id="description" placeholder="Qui uscir√† la descrizione..."></textarea>
      </div>
    </div>
  </section>

  <!-- TAB: STOCK -->
  <section id="tab-stock" style="display:none" class="grid">
    <div class="card">
      <h2>Magazzino</h2>

      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill">In magazzino: <strong id="countIn">0</strong></span>
          <span class="pill">Venduti: <strong id="countOut">0</strong></span>
          <span class="pill">Profitto totale: <strong id="profitTotal">0‚Ç¨</strong></span>
        </div>
        <div class="row">
          <input id="search" placeholder="Cerca (titolo, barcode, marca)..." style="min-width:220px" />
          <select id="filterStatus" style="max-width:170px">
            <option value="all">Tutti</option>
            <option value="in">Solo in magazzino</option>
            <option value="out">Solo venduti</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Stato</th>
              <th>Articolo</th>
              <th>Barcode</th>
              <th class="right">Acquisto</th>
              <th class="right">Consigliato</th>
              <th class="right">Venduto</th>
              <th class="right">Profitto</th>
              <th class="right">Azioni</th>
            </tr>
          </thead>
          <tbody id="stockBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- TAB: SETTINGS -->
  <section id="tab-settings" style="display:none" class="grid">
    <div class="card">
      <h2>Export / Import</h2>
      <p class="muted small" style="margin-top:0">
        Esporta il magazzino in JSON (backup) o importalo su un altro telefono/PC.
      </p>

      <div class="row">
        <button class="btn primary" id="exportBtn" type="button">Esporta JSON</button>
        <button class="btn" id="importBtn" type="button">Importa JSON</button>
        <input type="file" id="importFile" accept="application/json" style="display:none" />
      </div>

      <div class="divider"></div>

      <h2>Reset</h2>
      <div class="row">
        <button class="btn bad" id="wipeBtn" type="button">Cancella tutto (irreversibile)</button>
        <span class="muted small">Attenzione: elimina tutti gli articoli salvati.</span>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>

<!-- Barcode scanning library (ZXing) -->
<script src="https://unpkg.com/@zxing/library@0.21.2/umd/index.min.js"></script>

<script>
  const KEY = "used_inventory_v1";
  const $ = (id)=>document.getElementById(id);

  function loadItems(){
    try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch{ return []; }
  }
  function saveItems(items){
    localStorage.setItem(KEY, JSON.stringify(items));
  }
  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
  function eur(n){
    if(n === null || n === undefined || n === "" || isNaN(Number(n))) return "‚Äî";
    return Number(n).toFixed(2).replace(".", ",") + "‚Ç¨";
  }
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 1800);
  }

  // Tabs
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach(t=>{
    t.addEventListener("click", ()=>{
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const name = t.dataset.tab;
      ["add","stock","settings"].forEach(n=>{
        document.getElementById("tab-"+n).style.display = (n===name) ? "" : "none";
      });
      if(name==="stock") renderStock();
    });
  });

  // Photo capture + compress
  let photoDataUrl = "";
  $("photoInput").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const img = new Image();
    img.onload = ()=>{
      const max = 900;
      let w = img.width, h = img.height;
      const scale = Math.min(1, max / Math.max(w,h));
      w = Math.round(w*scale); h = Math.round(h*scale);
      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      const ctx = c.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);
      photoDataUrl = c.toDataURL("image/jpeg", 0.78);

      $("imgBox").innerHTML = "";
      const im = document.createElement("img");
      im.src = photoDataUrl;
      $("imgBox").appendChild(im);
      toast("Foto salvata");
    };
    img.src = URL.createObjectURL(file);
  });

  $("clearPhotoBtn").addEventListener("click", ()=>{
    photoDataUrl = "";
    $("photoInput").value = "";
    $("imgBox").innerHTML = '<span class="muted small">Nessuna foto</span>';
    toast("Foto rimossa");
  });

  // Barcode scanning (ZXing)
  let codeReader = null;
  let scanActive = false;

  async function startScan(){
    if(!window.isSecureContext){
      toast("Serve HTTPS per usare la camera");
      return;
    }
    if(scanActive) return;
    scanActive = true;

    $("startScanBtn").disabled = true;
    $("stopScanBtn").disabled = false;

    try{
      const ZXing = window.ZXing;
      codeReader = new ZXing.BrowserMultiFormatReader();

      const devices = await codeReader.listVideoInputDevices();
      let preferredId = devices?.[0]?.deviceId;
      const back = devices.find(d => /back|rear|environment/i.test(d.label));
      if(back) preferredId = back.deviceId;

      await codeReader.decodeFromVideoDevice(preferredId, $("video"), (result, err)=>{
        if(result){
          const text = result.getText();
          $("barcode").value = text;
          $("barcodePill").textContent = text;
          toast("Barcode letto: " + text);
          stopScan();
        }
      });
      toast("Scanner avviato");
    }catch(e){
      console.error(e);
      toast("Errore scanner: permessi/HTTPS/browser");
      $("startScanBtn").disabled = false;
      $("stopScanBtn").disabled = true;
      scanActive = false;
    }
  }

  async function stopScan(){
    try{
      if(codeReader){
        codeReader.reset();
      }
    }catch(e){}
    $("video").srcObject = null;
    $("startScanBtn").disabled = false;
    $("stopScanBtn").disabled = true;
    scanActive = false;
  }

  $("startScanBtn").addEventListener("click", startScan);
  $("stopScanBtn").addEventListener("click", stopScan);

  $("barcode").addEventListener("input", (e)=>{
    $("barcodePill").textContent = e.target.value || "‚Äî";
  });

  // Resale suggestion
  function suggestResale(newPrice, condition){
    const np = Number(newPrice);
    if(!np || isNaN(np)) return null;

    const map = {
      "Come nuovo": 0.72,
      "Ottime": 0.62,
      "Buone": 0.52,
      "Usato (segni evidenti)": 0.42,
      "Da sistemare / Ricambi": 0.22
    };
    const pct = map[condition] ?? 0.50;

    let v = np * pct;
    v = Math.max(5, v);
    v = Math.round(v / 5) * 5;
    v = Math.max(5, v) - 0.01;

    return Number(v.toFixed(2));
  }

  function buildDescription(data){
    const lines = [];
    const title = data.title?.trim() || "Articolo tecnologico";
    const cat = data.category || "Tech";
    const cond = data.condition || "Usato";
    const brand = data.brand?.trim();
    const barcode = data.barcode?.trim();
    const accessories = data.accessories?.trim();
    const notes = data.notes?.trim();

    lines.push(`‚úÖ VENDO: ${title}`);
    lines.push(`üìå Categoria: ${cat}`);
    if(brand) lines.push(`üè∑Ô∏è Marca: ${brand}`);
    lines.push(`üì¶ Condizioni: ${cond}`);

    if(accessories) lines.push(`üéÅ Inclusi: ${accessories}`);
    if(barcode) lines.push(`üîé Codice a barre (EAN/UPC): ${barcode}`);

    if(notes){
      lines.push("");
      lines.push("üßæ NOTE TRASPARENTI:");
      lines.push(notes);
    }

    lines.push("");
    lines.push("üìç Consegna: ritiro a mano / spedizione a carico dell‚Äôacquirente");
    lines.push("üí¨ Se vuoi foto/video extra o dettagli tecnici scrivimi pure.");
    lines.push("");
    lines.push("‚ö°Ô∏è Annuncio serio: niente perditempo.");

    return lines.join("\n");
  }

  function collectForm(){
    return {
      category: $("category").value,
      condition: $("condition").value,
      title: $("title").value,
      brand: $("brand").value,
      barcode: $("barcode").value,
      buyPrice: $("buyPrice").value,
      newPrice: $("newPrice").value,
      accessories: $("accessories").value,
      notes: $("notes").value,
      description: $("description").value,
      photoDataUrl,
    };
  }

  $("genBtn").addEventListener("click", ()=>{
    const data = collectForm();
    $("description").value = buildDescription(data);
    toast("Descrizione generata");
  });

  $("copyBtn").addEventListener("click", async ()=>{
    const txt = $("description").value.trim();
    if(!txt){ toast("Prima genera la descrizione"); return; }
    try{
      await navigator.clipboard.writeText(txt);
      toast("Copiata ‚úîÔ∏è");
    }catch{
      $("description").select();
      document.execCommand("copy");
      toast("Copiata ‚úîÔ∏è");
    }
  });

  $("suggestBtn").addEventListener("click", ()=>{
    const cond = $("condition").value;
    const np = $("newPrice").value;
    const v = suggestResale(np, cond);
    if(v===null){ toast("Inserisci il prezzo nuovo (oggi)"); return; }
    $("suggestedPill").textContent = eur(v);
    toast("Prezzo rivendita suggerito");
  });

  function clearForm(){
    ["title","brand","barcode","buyPrice","newPrice","accessories","notes","description"].forEach(id=>$(id).value="");
    // Secure context check
  if(!window.isSecureContext){
    $("secureBanner").style.display = "";
    $("startScanBtn").disabled = true;
    $("stopScanBtn").disabled = true;
  } else {
    $("secureBanner").style.display = "none";
  }

  $("barcodePill").textContent = "‚Äî";
    $("suggestedPill").textContent = "‚Äî";
    $("clearPhotoBtn").click();
  }

  $("saveBtn").addEventListener("click", ()=>{
    const data = collectForm();
    if(!data.title.trim()){
      toast("Metti almeno un titolo/modello");
      return;
    }
    if(!data.description.trim()){
      data.description = buildDescription(data);
      $("description").value = data.description;
    }
    const suggested = suggestResale(data.newPrice, data.condition);

    const item = {
      id: uid(),
      createdAt: new Date().toISOString(),
      status: "in",
      soldAt: null,
      soldPrice: null,
      suggestedPrice: suggested,
      ...data,
    };

    const items = loadItems();
    items.unshift(item);
    saveItems(items);
    toast("Salvato in magazzino ‚úîÔ∏è");
    clearForm();
  });

  function computeProfit(item){
    const buy = Number(item.buyPrice);
    const sold = Number(item.soldPrice);
    if(isNaN(buy) || isNaN(sold)) return null;
    return sold - buy;
  }

  function escapeHtml(s){
    return String(s || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      toast("Descrizione copiata ‚úîÔ∏è");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("Descrizione copiata ‚úîÔ∏è");
    }
  }

  function actionsHtml(it){
    if(it.status==="in"){
      return `
        <div class="row" style="justify-content:flex-end; gap:8px">
          <button class="btn" data-view type="button">Dettagli</button>
          <button class="btn" data-copy type="button">Copia</button>
          <input data-soldprice type="number" inputmode="decimal" placeholder="Venduto ‚Ç¨" style="width:110px;padding:10px 10px;border-radius:12px" />
          <button class="btn ok" data-evadi type="button">EVADI</button>
          <button class="btn bad" data-del type="button">üóëÔ∏è</button>
        </div>
      `;
    }
    return `
      <div class="row" style="justify-content:flex-end; gap:8px">
        <button class="btn" data-view type="button">Dettagli</button>
        <button class="btn" data-copy type="button">Copia</button>
        <button class="btn bad" data-del type="button">üóëÔ∏è</button>
      </div>
    `;
  }

  function doEvadi(id, soldPrice){
    const items = loadItems();
    const idx = items.findIndex(x=>x.id===id);
    if(idx<0) return;
    items[idx].status = "out";
    items[idx].soldPrice = Number(soldPrice);
    items[idx].soldAt = new Date().toISOString();
    saveItems(items);
    toast("Articolo evaso ‚úîÔ∏è");
    renderStock();
  }

  function doDelete(id){
    const items = loadItems().filter(x=>x.id!==id);
    saveItems(items);
    toast("Eliminato");
    renderStock();
  }

  function showDetails(it){
    const p = [];
    p.push("TITOLO: " + (it.title || "‚Äî"));
    p.push("CATEGORIA: " + (it.category || "‚Äî"));
    p.push("MARCA: " + (it.brand || "‚Äî"));
    p.push("CONDIZIONI: " + (it.condition || "‚Äî"));
    p.push("BARCODE: " + (it.barcode || "‚Äî"));
    p.push("ACQUISTO: " + eur(it.buyPrice));
    p.push("NUOVO (oggi): " + eur(it.newPrice));
    p.push("CONSIGLIATO: " + eur(it.suggestedPrice));
    p.push("STATO: " + (it.status==="in" ? "IN MAGAZZINO" : "VENDUTO"));
    if(it.status==="out"){
      p.push("VENDUTO A: " + eur(it.soldPrice));
      const pr = computeProfit(it);
      p.push("PROFITTO: " + (pr===null ? "‚Äî" : eur(pr)));
    }
    p.push("");
    p.push("DESCRIZIONE:");
    p.push(it.description || buildDescription(it));
    alert(p.join("\n"));
  }

  function renderStock(){
    const body = $("stockBody");
    body.innerHTML = "";

    const q = $("search").value.trim().toLowerCase();
    const f = $("filterStatus").value;

    const items = loadItems().filter(it=>{
      const hay = [it.title, it.brand, it.barcode].join(" ").toLowerCase();
      const okQ = !q || hay.includes(q);
      const okF = (f==="all") || (f===it.status);
      return okQ && okF;
    });

    let inCount = 0, outCount = 0, profitSum = 0;

    items.forEach(it=>{
      if(it.status==="in") inCount++;
      else outCount++;

      const profit = computeProfit(it);
      if(profit!==null) profitSum += profit;

      const tr = document.createElement("tr");

      const status = it.status==="in"
        ? `<span class="status in">IN</span>`
        : `<span class="status out">VENDUTO</span>`;

      const title = `<div style="font-weight:900">${escapeHtml(it.title || "‚Äî")}</div>
                     <div class="muted small">${escapeHtml(it.brand || "")} ‚Ä¢ ${escapeHtml(it.condition || "")}</div>`;

      const barcode = escapeHtml(it.barcode || "‚Äî");
      const buy = eur(it.buyPrice);
      const sugg = eur(it.suggestedPrice);
      const sold = (it.status==="out") ? eur(it.soldPrice) : "‚Äî";
      const prof = (it.status==="out" && profit!==null)
        ? (profit>=0 ? `<span style="color:var(--ok);font-weight:900">${eur(profit)}</span>`
                    : `<span style="color:var(--bad);font-weight:900">${eur(profit)}</span>`)
        : "‚Äî";

      tr.innerHTML = `
        <td>${status}</td>
        <td>${title}</td>
        <td>${barcode}</td>
        <td class="right">${buy}</td>
        <td class="right">${sugg}</td>
        <td class="right">${sold}</td>
        <td class="right">${prof}</td>
        <td class="right">${actionsHtml(it)}</td>
      `;

      body.appendChild(tr);

      const evBtn = tr.querySelector("[data-evadi]");
      if(evBtn){
        evBtn.addEventListener("click", ()=>{
          const priceInput = tr.querySelector("[data-soldprice]");
          const val = Number(priceInput.value);
          if(!val || isNaN(val)){
            toast("Inserisci prezzo venduto valido");
            return;
          }
          doEvadi(it.id, val);
        });
      }
      const copyBtn = tr.querySelector("[data-copy]");
      if(copyBtn){
        copyBtn.addEventListener("click", async ()=>{
          await copyText(it.description || buildDescription(it));
        });
      }
      const delBtn = tr.querySelector("[data-del]");
      if(delBtn){
        delBtn.addEventListener("click", ()=>{
          if(confirm("Eliminare questo articolo?")) doDelete(it.id);
        });
      }
      const viewBtn = tr.querySelector("[data-view]");
      if(viewBtn){
        viewBtn.addEventListener("click", ()=> showDetails(it));
      }
    });

    $("countIn").textContent = inCount;
    $("countOut").textContent = outCount;
    $("profitTotal").textContent = eur(profitSum);
  }

  $("search").addEventListener("input", renderStock);
  $("filterStatus").addEventListener("change", renderStock);

  // Export / Import / Wipe
  $("exportBtn").addEventListener("click", ()=>{
    const data = { exportedAt: new Date().toISOString(), items: loadItems() };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "magazzino-usato-backup.json";
    a.click();
    URL.revokeObjectURL(url);
    toast("Export pronto");
  });

  $("importBtn").addEventListener("click", ()=> $("importFile").click());

  $("importFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const json = JSON.parse(text);
      const items = json.items || json;
      if(!Array.isArray(items)) throw new Error("Formato non valido");
      saveItems(items);
      toast("Import completato ‚úîÔ∏è");
      document.querySelector('.tab[data-tab="stock"]').click();
    }catch(err){
      console.error(err);
      toast("Import fallito (JSON non valido)");
    }finally{
      e.target.value = "";
    }
  });

  $("wipeBtn").addEventListener("click", ()=>{
    const ok = confirm("Sicuro? Cancella TUTTO il magazzino.");
    if(!ok) return;
    localStorage.removeItem(KEY);
    toast("Dati cancellati");
    document.querySelector('.tab[data-tab="stock"]').click();
  });

  // init pills
  $("barcodePill").textContent = "‚Äî";
</script>
</body>
</html>
